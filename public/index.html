<!DOCTYPE html>
<html lang="ar">
<head>
    <!-- 🎯 Updated v2.7 - Fix API URLs: استخدام Render API بدلاً من Vercel -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>🎁 Arab Ton Gifts</title>
    <link rel="stylesheet" href="css/styles.css?v=2.6">
    <link rel="stylesheet" href="css/tasks.css?v=2.6">
    <link rel="stylesheet" href="css/channels-check.css?v=2.6">
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- ⚠️ SECURITY: PREVENT DIRECT BROWSER ACCESS -->
    <script>
    (function() {
        'use strict';
        
        // 🔐 Enhanced security checks
        
        // Check 1: Telegram WebApp SDK must exist
        if (!window.Telegram || !window.Telegram.WebApp) {
            showBlockPage();
            return;
        }
        
        const tg = window.Telegram.WebApp;
        
        // Check 2: Must have REAL initData from Telegram (not URL)
        if (!tg.initData || tg.initData.length < 50) {
            showBlockPage();
            return;
        }
        
        // Check 3: Must have user data
        if (!tg.initDataUnsafe || !tg.initDataUnsafe.user || !tg.initDataUnsafe.user.id) {
            showBlockPage();
            return;
        }
        
        // Check 4: Must be in Telegram environment (not standalone)
        if (!tg.platform || tg.platform === 'unknown') {
            showBlockPage();
            return;
        }
        
        // ✅ All checks passed - legitimate Telegram WebApp access
        console.log('✅ Telegram WebApp verified - User:', tg.initDataUnsafe.user.id);
        
        // 🔒 Freeze objects to prevent tampering
        try {
            Object.freeze(tg.initDataUnsafe);
            Object.freeze(tg);
            Object.seal(window.Telegram);
        } catch(e) {}
        
        function showBlockPage() {
            document.write(`
                <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; text-align: center; padding: 20px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial;">
                    <div style="background: rgba(0,0,0,0.3); padding: 40px; border-radius: 20px; backdrop-filter: blur(10px); max-width: 450px;">
                        <h1 style="font-size: 64px; margin-bottom: 20px; animation: bounce 2s infinite;">🐼</h1>
                        <h2 style="margin-bottom: 15px; font-size: 24px; color: #ffd43b;">مرحباً بك في Arab Ton Gifts!</h2>
                        <p style="font-size: 16px; line-height: 1.6; margin-bottom: 30px; opacity: 0.9;">للاستفادة من التطبيق، يجب فتحه من خلال البوت على Telegram</p>
                        <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 12px; margin-top: 20px; border: 1px solid rgba(255,255,255,0.2);">
                            <p style="font-size: 14px; margin: 0 0 15px 0; opacity: 0.9; font-weight: 600;">📲 ابحث عن البوت في Telegram:</p>
                            <code style="background: rgba(0,0,0,0.4); padding: 10px 20px; border-radius: 8px; font-size: 16px; display: inline-block; color: #5eabe1; font-weight: bold;">@Arab_ton_bot</code>
                        </div>
                        <p style="font-size: 11px; margin-top: 30px; opacity: 0.5;">🔒 Access through Telegram Bot only</p>
                    </div>
                </div>
                <style>
                @keyframes bounce {
                    0%, 100% { transform: translateY(0); }
                    50% { transform: translateY(-10px); }
                }
                </style>
            `);
            document.close();
            throw new Error('Direct browser access blocked - Telegram WebApp required');
        }
    })();
    </script>
    
    <!-- Lottie Player -->
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    
    <!-- Image Protection -->
    <style>
        /* منع تحديد النص والصور */
        img {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-user-drag: none;
            -webkit-touch-callout: none;
            pointer-events: none;
        }
        
        /* منع القائمة السياقية على الصور */
        img::selection {
            background: transparent;
        }
        
        /* إخفاء المحتوى حتى يتم التحقق من البيانات */
        body.loading .app-header,
        body.loading .main-container,
        body.loading .bottom-nav {
            display: none !important;
        }
        
        /* عرض شاشة التحميل فقط في البداية */
        body.loading #loading-overlay {
            display: flex !important;
        }
    </style>
    <script>
        // منع النقر بالزر الأيمن على الصور
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('contextmenu', function(e) {
                if (e.target.tagName === 'IMG') {
                    e.preventDefault();
                    return false;
                }
            });
            
            // منع السحب والإفلات للصور
            document.addEventListener('dragstart', function(e) {
                if (e.target.tagName === 'IMG') {
                    e.preventDefault();
                    return false;
                }
            });
            
            // حماية من F12 و Inspect
            document.addEventListener('keydown', function(e) {
                if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I')) {
                    e.preventDefault();
                    return false;
                }
            });
        });
    </script>
</head>
<body class="loading">
    
    <!-- 🔝 HEADER - معلومات المستخدم -->
    <header id="app-header" class="app-header">
        <div class="user-profile">
            <div class="user-avatar">
                <img id="user-avatar" src="" alt="User Avatar">
            </div>
            <div class="user-info">
                <h3 id="user-name">جاري التحميل...</h3>
                <p id="user-username">@username</p>
            </div>
        </div>
        <div class="user-balance">
            <span class="balance-label"><img src="img/Ton.png" alt="TON" class="ton-icon"> الرصيد</span>
            <span class="balance-amount" id="user-balance">0.0000</span>
            <!-- <span class="balance-currency"><img src="img/Ton.png" alt="TON" class="ton-icon"></span> -->
        </div>
    </header>

    <!-- 📱 MAIN CONTAINER -->
    <main class="main-container">
        
        <!-- 🎰 الصفحة الرئيسية - عجلة الحظ -->
        <section id="page-wheel" class="page active">
            <div class="spins-info">
                <div class="spins-available">
                    <span class="spins-count" id="available-spins">0</span>
                    <span class="spins-label">لفة متاحة</span>
                </div>
            </div>

            <!-- عجلة الحظ -->
            <div class="wheel-container">
                <div class="wheel-wrapper">
                    <div class="wheel-pointer"></div>
                    <canvas id="wheel-canvas" width="350" height="350"></canvas>
                    <button id="spin-button" class="spin-button">لف الآن</button>
                </div>
            </div>

            <!-- نتيجة اللفة -->
            <div id="spin-result" class="spin-result hidden">
                <lottie-player id="success-animation" src="./img/success_stars.json" 
                    background="transparent" speed="1" style="width: 150px; height: 150px; margin: 0 auto;" 
                    loop autoplay>
                </lottie-player>
                <h2 id="result-text">🎉 تهانينا!</h2>
                <p id="result-amount"></p>
            </div>

            <!-- آخر الأرباح -->
            <div class="recent-wins">
                <h3>🏆 آخر أرباحك</h3>
                <div id="recent-wins-list" class="wins-list">
                    <!-- سيتم ملؤها ديناميكياً -->
                </div>
            </div>
        </section>

        <!--  صفحة المهام -->
        <section id="page-tasks" class="page">
            <div class="page-header">
                <h2>
                    <lottie-player src="./img/task.json" background="transparent" speed="1" 
                        style="width: 32px; height: 32px; display: inline-block; vertical-align: middle;" 
                        loop autoplay>
                    </lottie-player>
                    المهام
                </h2>
                <p class="page-description">أكمل المهام واحصل على لفات مجانية!</p>
            </div>

            <div class="tasks-progress">
                <div class="progress-info">
                    <span>📊 تقدمك: <strong id="completed-tasks-count">0</strong> / <strong id="total-tasks-count">0</strong></span>
                    <span style="margin-right: 16px; color: #ffd436;">متبقي <strong id="tasks-remaining">5</strong> / 5 للفة القادمة</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="tasks-progress-fill"></div>
                </div>
            </div>

            <!-- قائمة المهام -->
            <div class="tasks-container" id="tasks-list">
                <!-- Loading state -->
                <div class="tasks-loading">
                    <lottie-player src="./img/login.json" background="transparent" speed="1" 
                        style="width: 100px; height: 100px;" loop autoplay>
                    </lottie-player>
                    <p>جاري تحميل المهام...</p>
                </div>
            </div>
        </section>

        <!-- 💸 صفحة السحب -->
        <section id="page-withdraw" class="page">
            <div class="page-header">
                <h2>
                    <lottie-player src="./img/withdraw.json" background="transparent" speed="1" 
                        style="width: 32px; height: 32px; display: inline-block; vertical-align: middle;" 
                        loop autoplay>
                    </lottie-player>
                    السحب
                </h2>
            </div>

            <div class="balance-display">
                <div class="balance-card">
                    <span class="balance-label"><img src="img/Ton.png" alt="TON" class="ton-icon"> رصيدك الحالي</span>
                    <span class="balance-value" id="withdraw-balance">0.0000</span>
                    <!-- <span class="balance-currency"><img src="img/Ton.png" alt="TON" class="ton-icon"></span> -->
                </div>
            </div>

            <!-- طرق السحب -->
            <div class="withdrawal-methods">
                <h3>اختر طريقة السحب</h3>
                
                <div class="method-tabs">
                    <button class="method-tab active" data-method="ton">
                        <span class="tab-icon"><img src="img/Ton.png" alt="TON" class="ton-icon-tab"></span>
                        <span>TON Wallet</span>
                    </button>
                    <button class="method-tab" data-method="vodafone">
                        <span class="tab-icon"><img src="img/vodafone.png" alt="Vodafone" class="ton-icon-tab"></span>
                        <span>Vodafone Cash</span>
                    </button>
                </div>

                <!-- نموذج السحب TON -->
                <div id="withdraw-form-ton" class="withdraw-form active">
                    <div class="form-group">
                        <label><img src="img/Ton.png" alt="TON" class="ton-icon"> عنوان محفظة TON</label>
                        <input type="text" id="ton-wallet-input" placeholder="UQxxxxxxxxxxxxxxxx">
                    </div>
                    <div class="form-group">
                        <label><img src="img/Ton.png" alt="TON" class="ton-icon"> المبلغ (TON)</label>
                        <div class="amount-input-group">
                            <input type="number" id="ton-amount-input" placeholder="0.00" step="0.01" min="0.1">
                            <button id="max-btn-ton" class="max-btn">MAX</button>
                        </div>
                        <span class="min-withdraw-note">الحد الأدنى: 0.1 <img src="img/Ton.png" alt="TON" class="ton-icon-small"></span>
                    </div>
                    <button id="withdraw-btn-ton" class="withdraw-btn">
                        <lottie-player src="./img/withdraw.json" background="transparent" speed="1" 
                            style="width: 24px; height: 24px; display: inline-block; vertical-align: middle;" 
                            loop autoplay>
                        </lottie-player>
                        طلب السحب
                    </button>
                </div>

                <!-- نموذج السحب Vodafone -->
                <div id="withdraw-form-vodafone" class="withdraw-form">
                    <div class="form-group">
                        <label><img src="img/vodafone.png" alt="Vodafone" class="ton-icon"> رقم فودافون كاش</label>
                        <input type="tel" id="vodafone-number-input" placeholder="01xxxxxxxxx">
                    </div>
                    <div class="form-group">
                        <label><img src="img/Ton.png" alt="TON" class="ton-icon"> المبلغ (TON)</label>
                        <div class="amount-input-group">
                            <input type="number" id="vodafone-amount-input" placeholder="0.00" step="0.01" min="0.1">
                            <button id="max-btn-vodafone" class="max-btn">MAX</button>
                        </div>
                        <span class="min-withdraw-note">الحد الأدنى: 0.1 <img src="img/Ton.png" alt="TON" class="ton-icon-small"></span>
                    </div>
                    <button id="withdraw-btn-vodafone" class="withdraw-btn">
                        <lottie-player src="./img/withdraw.json" background="transparent" speed="1" 
                            style="width: 24px; height: 24px; display: inline-block; vertical-align: middle;" 
                            loop autoplay>
                        </lottie-player>
                        طلب السحب
                    </button>
                </div>
            </div>

            <!-- سجل السحوبات -->
            <div class="withdrawal-history">
                <h3>
                    <img src="img/profile/orders_history.svg" alt="History" style="width: 24px; height: 24px; display: inline-block; vertical-align: middle;">
                    سجل السحوبات
                </h3>
                <div id="withdrawal-history-list" class="history-list">
                    <!-- سيتم ملؤها ديناميكياً -->
                </div>
            </div>
        </section>

    </main>

    <!-- 📱 BOTTOM NAVIGATION -->
    <nav class="bottom-nav">
        <button class="nav-item" data-page="withdraw">
            <span class="nav-icon">
                <lottie-player src="./img/withdraw.json" background="transparent" speed="1" 
                    style="width: 32px; height: 32px;" loop autoplay>
                </lottie-player>
            </span>
            <span class="nav-label">السحب</span>
        </button>
        <button class="nav-item" data-page="tasks">
            <span class="nav-icon">
                <lottie-player src="./img/task.json" background="transparent" speed="1" 
                    style="width: 32px; height: 32px;" loop autoplay>
                </lottie-player>
            </span>
            <span class="nav-label">المهام</span>
        </button>
        <button class="nav-item" onclick="navigateToReferrals()">
            <span class="nav-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                </svg>
            </span>
            <span class="nav-label">الإحالات</span>
        </button>
        <button class="nav-item active" data-page="wheel">
            <span class="nav-icon">
                <lottie-player src="./img/roll.json" background="transparent" speed="1" 
                    style="width: 32px; height: 32px;" loop autoplay>
                </lottie-player>
            </span>
            <span class="nav-label">العجلة</span>
        </button>
    </nav>

    <!-- 🔔 TOAST NOTIFICATIONS -->
    <div id="toast-container" class="toast-container"></div>

    <!-- ⏳ LOADING OVERLAY -->
    <div id="loading-overlay" class="loading-overlay">
        <lottie-player src="./img/login.json" 
            background="transparent" speed="1" style="width: 200px; height: 200px;" 
            loop autoplay>
        </lottie-player>
        <p class="loading-text">جاري التحميل...</p>
    </div>

    <!-- 🎉 WIN MODAL -->
    <div id="win-modal" class="modal">
        <div class="modal-content win-modal">
            <lottie-player id="win-animation" src="./img/success_stars.json" 
                background="transparent" speed="1" style="width: 200px; height: 200px; margin: 0 auto;" 
                loop autoplay>
            </lottie-player>
            <h2 id="modal-win-title">🎉 تهانينا!</h2>
            <p id="modal-win-amount"></p>
            <button class="modal-btn" onclick="closeWinModal()">رائع! 🎊</button>
        </div>
    </div>

    <!-- 📢 CHANNELS VERIFICATION MODAL -->
    <div id="channels-modal" class="modal" style="display: none;">
        <div class="modal-content channels-modal">
            <h2 style="text-align: center; margin-bottom: 20px;">🔔 اشترك في القنوات الإجبارية</h2>
            <p style="text-align: center; color: var(--text-secondary); margin-bottom: 20px;">
                للاستمرار في استخدام البوت، يجب الاشتراك في القنوات التالية:
            </p>
            <div id="channels-list" class="channels-list"></div>
            <button id="verify-channels-btn" class="modal-btn" style="margin-top: 20px;">
                <img src="/img/payment-success.svg" alt="تحقق" style="width: 18px; height: 18px; vertical-align: middle; margin-left: 4px;"> تحقق من الاشتراك
            </button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/debug.js?v=2.7&t=1707370000"></script>
    <script src="js/config.js?v=2.7&t=1707370000"></script>
    <script src="js/api.js?v=2.7&t=1707370000"></script>
    <script src="js/tasks.js?v=2.7&t=1707370000"></script>
    <script src="js/channels-check.js?v=2.7&t=1707370000"></script>
    <script src="js/channels.js?v=2.7&t=1707370000"></script>
    <script src="js/wheel.js?v=2.7&t=1707370000"></script>
    <script src="js/app.js?v=2.7&t=1707370000"></script>
</body>
</html>

