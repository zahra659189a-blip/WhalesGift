<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="robots" content="noindex,follow">
    <title>برنامج الإحالة - 🐼 Panda Giveaways</title>
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Sweetalert2 -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>

    <!-- Lottie Player -->
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>

    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/base_v2026.css?v=2026">
    <link rel="stylesheet" href="css/profile.css">
    <link rel="stylesheet" href="css/profile_menu.css">
    <link rel="stylesheet" href="css/referral_program.css">
    <link rel="stylesheet" href="css/styles.css">
</head>

<body class="ar">
    <div class="container main-container">
        <svg xmlns="http://www.w3.org/2000/svg" style="position:absolute;width:0;height:0;left:-10000px">
            <defs>
                <path d="M 6.67 5.74 L 8.88 1.32 C 9.13 0.81 9.74 0.6 10.25 0.86 C 10.45 0.96 10.61 1.13 10.71 1.33 L 12.79 5.59 C 12.96 5.93 13.29 6.17 13.67 6.22 L 18.03 6.74 C 18.62 6.82 19.05 7.36 18.98 7.96 C 18.95 8.2 18.84 8.43 18.66 8.61 L 15.21 12.03 C 15.07 12.16 15.01 12.36 15.03 12.56 L 15.6 17.17 C 15.69 17.83 15.22 18.44 14.57 18.52 C 14.32 18.55 14.07 18.5 13.85 18.38 L 10.21 16.38 C 9.95 16.24 9.63 16.23 9.36 16.37 L 5.59 18.32 C 5.06 18.59 4.41 18.38 4.14 17.84 C 4.03 17.64 4 17.41 4.03 17.19 L 4.33 15.07 C 4.48 14.03 5.12 13.14 6.04 12.66 L 10.23 10.51 C 10.34 10.45 10.38 10.31 10.33 10.2 C 10.28 10.11 10.19 10.06 10.09 10.08 L 4.97 10.82 C 4.19 10.93 3.39 10.71 2.78 10.2 L 1.07 8.8 C 0.58 8.4 0.51 7.68 0.9 7.18 C 1.09 6.96 1.35 6.81 1.64 6.77 L 6.02 6.2 C 6.3 6.17 6.54 5.99 6.67 5.74 Z" id="icon-star"></path>
                <linearGradient x1="25%" y1="0.825%" x2="74.92%" y2="107.86%" id="s2"><stop stop-color="#FFD951" offset="0%"></stop><stop stop-color="#FFB222" offset="100%"></stop></linearGradient>
                <linearGradient x1="50%" y1="0%" x2="50%" y2="99.8%" id="s3"><stop stop-color="#E58F0D" offset="0%"></stop><stop stop-color="#EB7915" offset="100%"></stop></linearGradient>
                <filter x="-5.2%" y="-5.3%" width="110.3%" height="110.6%" filterUnits="objectBoundingBox" id="s4"><feOffset dx="1" dy="1" in="SourceAlpha" result="shadowOffsetInner1"></feOffset><feComposite in="shadowOffsetInner1" in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1" result="shadowInnerInner1"></feComposite><feColorMatrix values="0 0 0 0 1 0 0 0 0 1 0 0 0 0 1 0 0 0 0.657 0" type="matrix" in="shadowInnerInner1"></feColorMatrix></filter>
                <g id="icon-multi-star" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                    <use stroke="currentColor" stroke-width="2.67" xlink:href="#icon-star"></use>
                    <use fill="url(#s2)" fill-rule="evenodd" xlink:href="#icon-star"></use>
                    <use fill="#000" filter="url(#s4)" xlink:href="#icon-star"></use>
                    <use stroke="url(#s3)" stroke-width="0.89" xlink:href="#icon-star"></use>
                    <path d="M 4 19 L 14 19 L 9 16.5 L 4 19 Z" fill="currentColor"></path>
                </g>
            </defs>
        </svg>

        <!-- Page Title Header -->
        <div class="page-title-header">
            <img src="img/profile/referral_program.svg" alt="برنامج الإحالة" class="page-title-icon">
            <h1 class="page-title">برنامج الإحالة</h1>
        </div>

        <div class="section profile-section">
            <div class="profile-section-main-wrapper">
                <div class="profile-section-main">
                    <div class="profile-info-wrapper">
                        <div class="tg-info-wrapper">
                            <img class="img user-profile-image" src="img/default-avatar.svg" alt="User" id="user-profile-image">
                            <p class="username"><b><span class="at-symbol">@</span><span id="myself">loading...</span></b></p>
                        </div>
                        <div class="stats-wrapper">
                            <div class="stats-item">
                                <div class="stats-name">عدد إحالاتك:</div>
                                <div class="stats" id="total-referrals">0</div>
                            </div>
                            <div class="stats-item stats-item-level">
                                <div class="stats-name">متبقي للفة القادمة:</div>
                                <div class="stats" id="next-spin-in">5</div>
                            </div>
                            <div class="stats-item">
                                <div class="stats-name">اللفات المتاحة:</div>
                                <div class="stats" id="available-spins">0</div>
                            </div>
                        </div>
                    </div>


                </div>
            </div>

            <div class="profile-section-content-wrapper">
                <div class="profile-section-content">
                    <div class="section-referral-program">
                        <div class="referral-link-wrapper">
                            <div>رابط الإحالة الخاص بك:</div>
                            <div class="icon-before icon-referral tm-field tm-referral-field js-stars-referral-field">
                                <input type="text" id="user-referral-link" value="Loading..." class="form-control tm-input tm-referral-input" name="referral_link" placeholder="http://PandaStore.store/ar?referral=..." autocomplete="off" spellcheck="false" readonly>
                                <span class="icon-before icon-referral-copy tm-referral-copy js-form-copy"></span>
                            </div>
                        </div>

                        <div class="referral-wrapper">
                            <div id="referrals-list-container">
                                <div class="empty-no-data-wrapper">
                                    <svg width="64" height="41" viewBox="0 0 64 41" xmlns="http://www.w3.org/2000/svg"><title>لا توجد بيانات</title><g transform="translate(0 1)" fill="none" fill-rule="evenodd"><ellipse fill="#d2d2d2" cx="32" cy="33" rx="32" ry="7"></ellipse><g fill-rule="nonzero" stroke="#000000"><path d="M55 12.76L44.854 1.258C44.367.474 43.656 0 42.907 0H21.093c-.749 0-1.46.474-1.947 1.257L9 12.761V22h46v-9.24z"></path><path d="M41.613 15.931c0-1.605.994-2.93 2.227-2.931H55v18.137C55 33.26 53.68 35 52.05 35h-40.1C10.32 35 9 33.259 9 31.137V13h11.16c1.233 0 2.227 1.323 2.227 2.928v.022c0 1.605 1.005 2.901 2.237 2.901h14.752c1.232 0 2.237-1.308 2.237-2.913v-.007z" fill="#d2d2d2"></path></g></g></svg>
                                    <span>لا توجد بيانات</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ⏳ LOADING OVERLAY -->
    <div id="loading-overlay" class="loading-overlay">
        <lottie-player src="./img/loginSticker.json" 
            background="transparent" speed="1" style="width: 200px; height: 200px;" 
            loop autoplay>
        </lottie-player>
        <p class="loading-text">جاري تحميل بيانات الإحالة...</p>
    </div>

    <!-- 📱 BOTTOM NAVIGATION -->
    <nav class="bottom-nav">
        <button class="nav-item" onclick="window.location.href='index.html?page=withdraw'">
            <span class="nav-icon">
                <lottie-player src="./img/withdraw.json" background="transparent" speed="1" 
                    style="width: 32px; height: 32px;" loop autoplay>
                </lottie-player>
            </span>
            <span class="nav-label">السحب</span>
        </button>
        <button class="nav-item" onclick="window.location.href='index.html?page=tasks'">
            <span class="nav-icon">
                <lottie-player src="./img/task.json" background="transparent" speed="1" 
                    style="width: 32px; height: 32px;" loop autoplay>
                </lottie-player>
            </span>
            <span class="nav-label">المهام</span>
        </button>
        <button class="nav-item active">
            <span class="nav-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                </svg>
            </span>
            <span class="nav-label">الإحالات</span>
        </button>
        <button class="nav-item" onclick="window.location.href='index.html'">
            <span class="nav-icon">
                <lottie-player src="./img/roll.json" background="transparent" speed="1" 
                    style="width: 32px; height: 32px;" loop autoplay>
                </lottie-player>
            </span>
            <span class="nav-label">العجلة</span>
        </button>
    </nav>

    <script>
        // Initialize Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        
        // Get user data from Telegram
        const telegramUser = tg.initDataUnsafe?.user;
        const userId = telegramUser?.id || null;
        const username = telegramUser?.username || telegramUser?.first_name || 'username';
        
        $('.js-form-copy').on('click', function() {
            const input = document.querySelector('input[name="referral_link"]');
            const tempValue = input.value;
            
            // Try to use Telegram's haptic feedback
            if (tg.HapticFeedback) {
                tg.HapticFeedback.notificationOccurred('success');
            }
            
            navigator.clipboard.writeText(tempValue).then(() => {
                $('.icon-referral-copy').addClass('copied');
                tg.showPopup({
                    message: '✓ تم نسخ رابط الإحالة!',
                    buttons: [{type: 'ok'}]
                });
                setTimeout(() => {
                    $('.icon-referral-copy').removeClass('copied');
                }, 1500);
            }).catch(() => {
                // Fallback for older browsers
                input.select();
                document.execCommand('copy');
                $('.icon-referral-copy').addClass('copied');
                setTimeout(() => {
                    $('.icon-referral-copy').removeClass('copied');
                }, 1500);
            });
        });

        // Load user data and stats
        $(document).ready(async function() {
            // Show loading
            $('#loading-overlay').removeClass('hidden');
            
            // Display user info
            $('#myself').text(username);
            
            // Set user avatar from Telegram
            if (telegramUser?.photo_url) {
                $('#user-profile-image').attr('src', telegramUser.photo_url);
            }
            
            // Check if userId exists
            if (!userId) {
                console.error('No user ID found. Please open from Telegram.');
                $('#total-referrals, #available-spins, #next-spin-in').text('--');
                return;
            }
            
            // تحديث بيانات المستخدم من Telegram أولاً
            try {
                const username = telegramUser.username || `user_${userId}`;
                const fullName = telegramUser.first_name + (telegramUser.last_name ? ' ' + telegramUser.last_name : '') || username;
                
                await fetch(`/api/user/${userId}/update-profile`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        full_name: fullName
                    })
                });
                console.log('✅ Profile updated with Telegram data');
            } catch (profileError) {
                console.warn('⚠️ Could not update profile:', profileError);
            }
            
            // Generate referral link (format: https://t.me/BotUsername?start=ref_12345)
            const botUsername = 'PandaGiveawaysBot'; // يمكنك تغيير اسم البوت هنا
            const referralLink = `https://t.me/${botUsername}?start=ref_${userId}`;
            $('#user-referral-link').val(referralLink);
            
            // Load user data and referral stats from API
            Promise.all([
                fetch(`/api/user/${userId}`).then(res => res.json()),
                fetch(`/api/user/${userId}/referrals`).then(res => res.json())
            ])
            .then(([userData, referralsData]) => {
                console.log('User Data:', userData);
                console.log('Referrals Data:', referralsData);
                
                // Update stats from user data
                if (userData.success && userData.data) {
                    const user = userData.data;
                    $('#available-spins').text(user.available_spins || 0);
                    
                    // Use total_referrals from API response (not referral_count)
                    const referralCount = user.total_referrals || 0;
                    const remainingForNext = referralCount === 0 ? 5 : (5 - (referralCount % 5));
                    
                    $('#total-referrals').text(referralCount);
                    $('#next-spin-in').text(remainingForNext);
                }
                
                // Load referrals list
                if (referralsData.success && referralsData.data && referralsData.data.length > 0) {
                    let html = '';
                    referralsData.data.forEach((referral, index) => {
                        console.log('Referral item:', referral);
                        
                        const fullName = referral.full_name || `مستخدم ${referral.referred_id}`;
                        const usernameOnly = referral.username || '';
                        const username = usernameOnly ? `@${usernameOnly}` : '';
                        
                        // الحصول على صورة Telegram الحقيقية من API باستخدام username
                        const avatarUrl = usernameOnly ? `https://t.me/i/userpic/320/${usernameOnly}.jpg` : '';
                        const fallbackUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(fullName)}&background=4a9eff&color=fff&size=64`;
                        
                        const telegramLink = usernameOnly ? `https://t.me/${usernameOnly}` : '#';
                        
                        html += `
                            <a href="${telegramLink}" class="referral-item" ${usernameOnly ? 'target="_blank"' : 'onclick="return false;"'}>
                                <img src="${avatarUrl}" 
                                     onerror="this.src='${fallbackUrl}'" 
                                     alt="${fullName}" 
                                     class="referral-avatar">
                                <div class="referral-info">
                                    <div class="referral-name">${fullName}</div>
                                    ${username ? `<div class="referral-username">${username}</div>` : ''}
                                </div>
                                <div class="referral-number">${index + 1}</div>
                            </a>
                        `;
                    });
                    $('#referrals-list-container').html(html);
                } else {
                    console.log('No referrals found or empty data');
                }
                
                // Hide loading after data is loaded
                $('#loading-overlay').addClass('hidden');
            })
            .catch(error => {
                console.error('Error loading data:', error);
                // Show default values on error
                $('#total-referrals').text('0');
                $('#available-spins').text('0');
                $('#next-spin-in').text('5');
                
                // Hide loading even on error
                $('#loading-overlay').addClass('hidden');
            });
        });

        function logoutUser() {
            if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
                localStorage.removeItem('telegram_user');
                localStorage.removeItem('telegram_user_id');
                localStorage.removeItem('telegram_username');
                localStorage.removeItem('user_referral_code');
                localStorage.removeItem('telegram_login_timestamp');
                window.location.href = '/ar';
            }
        }
    </script>
</body>
</html>
