<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø²</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
<style>
:root { --bg:#0f1115; --card:#181c22; --accent:#5b8bff; --accent-grad:linear-gradient(135deg,#5b8bff,#936bff 55%,#ff7ac6); --text:#e7ecf2; --danger:#ff4d61; --success:#35c06e; --border:1px solid #252b33; font-family:'Segoe UI',Tahoma,Arial,sans-serif; }
body {background:radial-gradient(circle at 20% 20%, #1e2530, #0d0f13);margin:0;padding:0;color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center;}
.container {width:min(480px,92%);background:var(--card);padding:32px 30px 40px;border-radius:24px;box-shadow:0 8px 28px -6px rgba(0,0,0,.55),0 0 0 1px rgba(255,255,255,.04);position:relative;overflow:hidden;}
.container:before {content:"";position:absolute;inset:0;background:conic-gradient(from 180deg at 50% 50%,rgba(255,255,255,.06),transparent 35% 70%,rgba(255,255,255,.06));mix-blend-mode:overlay;pointer-events:none;}
header {text-align:center;margin-bottom:26px;}
header h1 {margin:0;font-size:1.55rem;letter-spacing:.5px;background:var(--accent-grad);-webkit-background-clip:text;background-clip:text;color:transparent;font-weight:600;}
header p {margin:10px 0 0;font-size:.9rem;opacity:.85;line-height:1.4;}
.animation-box {display:flex;justify-content:center;align-items:center;min-height:200px;margin:20px 0;}
.animation-box lottie-player {width:200px;height:200px;}
.status-icon {width:80px;height:80px;margin:20px auto;display:none;}
.status-icon.show {display:block;}
.status {margin-top:14px;font-size:1rem;font-weight:600;text-align:center;padding:12px;border-radius:12px;}
.status.ok {color:var(--success);background:rgba(53,192,110,.1);} 
.status.err {color:var(--danger);background:rgba(255,77,97,.1);} 
.status.pending {color:#ffc861;background:rgba(255,200,97,.1);}
footer {margin-top:30px;text-align:center;font-size:.7rem;opacity:.55;}
.glow {position:absolute;inset:0;pointer-events:none;}
.glow:before, .glow:after {content:"";position:absolute;border-radius:50%;filter:blur(70px);opacity:.5;animation:float 8s ease-in-out infinite;}
.glow:before {width:320px;height:320px;background:#5b8bff;top:-120px;left:-120px;animation-delay:-2s;}
.glow:after {width:260px;height:260px;background:#ff7ac6;bottom:-100px;right:-90px;}
@keyframes float {0%,100% {transform:translateY(0);}50% {transform:translateY(40px);}}
.hidden {display:none!important;}
</style>
</head>
<body>
  <div class="container">
    <div class="glow"></div>
    <header>
      <h1>ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø²</h1>
      <p>Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø¶Ù…Ø§Ù† Ù†Ø²Ø§Ù‡Ø© Ø§Ù„Ù†Ø¸Ø§Ù…...</p>
    </header>
    
    <div class="animation-box">
      <lottie-player id="animationPlayer" src="/img/preloaderSticker.json" background="transparent" speed="1" loop autoplay></lottie-player>
    </div>
    
    <img id="statusIcon" class="status-icon" src="" alt="">
    
    <div id="status" class="status pending">ğŸ” Ø¬Ø§Ø±Ù ÙØ­Øµ Ø§Ù„Ø¬Ù‡Ø§Ø²...</div>
    
    <footer>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙØ³ØªØ®Ø¯Ù… Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Ø§Ù„ØªÙ„Ø§Ø¹Ø¨.</footer>
  </div>
<script>
// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù€ API
const API_CONFIG = {
  BASE_URL: 'https://WhalesGift.onrender.com',
  getApiUrl: function() {
    // Ø§Ø³ØªØ®Ø¯Ù… Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø§Ù„Ù€ full URL Ù„Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø³ÙŠØ±ÙØ±
    return this.BASE_URL;
  }
};

console.log('ğŸŒ Frontend URL:', window.location.href);
console.log('ğŸ”— API Server URL:', API_CONFIG.BASE_URL);

(function initTelegram(){
  if(window.Telegram && Telegram.WebApp){
    try { Telegram.WebApp.ready(); Telegram.WebApp.expand(); } catch(e) {}
  }
})();

function getUserIdFromUrl(){
  try {
    const params = new URLSearchParams(location.search);
    const userId = params.get('user_id');
    if(userId && /^\d+$/.test(userId)) return parseInt(userId);
    
    const hashParams = new URLSearchParams(location.hash.replace(/^#/, ''));
    const hashUserId = hashParams.get('user_id');
    if(hashUserId && /^\d+$/.test(hashUserId)) return parseInt(hashUserId);
  } catch(e) {
    console.error('Error extracting user_id:', e);
  }
  return null;
}

function getReferrerIdFromUrl(){
  try {
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ù† start_param ÙÙŠ initDataUnsafe
    const initData = window.Telegram?.WebApp?.initDataUnsafe;
    if(initData?.start_param) {
      const startParam = initData.start_param;
      if(startParam.startsWith('ref_')) {
        return parseInt(startParam.replace('ref_', ''));
      }
    }
    
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ù† URL parameters
    const params = new URLSearchParams(location.search);
    const refParam = params.get('referrer_id') || params.get('ref');
    if(refParam && /^\d+$/.test(refParam)) return parseInt(refParam);
  } catch(e) {
    console.error('Error extracting referrer_id:', e);
  }
  return null;
}

(async function(){
  const animationPlayer = document.getElementById('animationPlayer');
  const statusIcon = document.getElementById('statusIcon');
  const status = document.getElementById('status');
  const outsideHint = document.getElementById('outsideHint');

  
  function localId(){
    const k='__fp_local_id';
    let id=localStorage.getItem(k);
    if(!id){ id=crypto.randomUUID(); localStorage.setItem(k,id);} return id;
  }

  async function canvasFP(){
    try { const c=document.createElement('canvas'); c.width=220; c.height=40; const ctx=c.getContext('2d'); ctx.textBaseline='top'; ctx.font='16px Arial'; ctx.fillText('Fingerprint Canvas Test',4,4); const data=c.toDataURL(); return await digest(data);} catch(e){return 'NA'} }
  async function audioFP(){
    try { const ctx=new (window.AudioContext||window.webkitAudioContext)(); const osc=ctx.createOscillator(); const analyser=ctx.createAnalyser(); osc.type='triangle'; osc.frequency.value=111; osc.connect(analyser); osc.start(); const arr=new Uint8Array(analyser.frequencyBinCount); analyser.getByteFrequencyData(arr); osc.stop(); ctx.close(); return await digest(arr.join(',')); } catch(e){return 'NA'} }
  async function digest(str){ const buf=new TextEncoder().encode(str); const h=await crypto.subtle.digest('SHA-256',buf); return Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,'0')).join('').slice(0,32); }

  async function build(){
    console.log('ğŸ” Starting fingerprint build...');
    const ua=navigator.userAgent; 
    const rez=screen.width+'x'+screen.height; 
    const tz=Intl.DateTimeFormat().resolvedOptions().timeZone || 'NA'; 
    const lid=localId(); 
    const cfp=await canvasFP(); 
    const afp=await audioFP();
    const raw = ua+'|'+rez+'|'+tz+'|'+lid+'|'+cfp+'|'+afp; 
    const final = await digest(raw);
    console.log('âœ… Fingerprint generated:', final.substring(0, 16) + '...');
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ IP address (Ø¨Ø¯ÙˆÙ† Ø¹Ø±Ø¶Ù‡)
    let userIP = 'Unknown';
    try {
      const ipResp = await fetch('https://api.ipify.org?format=json');
      const ipData = await ipResp.json();
      userIP = ipData.ip || 'Unknown';
      console.log('ğŸ“ IP Address detected');
    } catch(e) {
      console.error('Failed to get IP:', e);
    }
    
    status.textContent='ğŸ“¡ Ø¬Ø§Ø±Ù Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';
    status.className='status pending';
    
    async function doSend(){
      const uid = getUserIdFromUrl();
      // ğŸ” Ø¬Ù„Ø¨ fp_token Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù† (Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† URL)
      let fpToken = null;
      
      try {
        status.textContent='ğŸ” Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‡ÙˆÙŠØ©...';
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Telegram init data
        const initData = window.Telegram?.WebApp?.initData;
        if (!initData) {
          throw new Error('ÙŠØ¬Ø¨ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ù…Ù† Telegram');
        }
        
        // Ø·Ù„Ø¨ Ø§Ù„ØªÙˆÙƒÙ† Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù†
        const tokenApiUrl = `${API_CONFIG.getApiUrl()}/api/verification/get-token`;
        const tokenResp = await fetch(tokenApiUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Telegram-Init-Data': initData
          }
        });
        
        if (!tokenResp.ok) {
          const errorData = await tokenResp.json();
          throw new Error(errorData.error || 'ÙØ´Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙˆÙƒÙ† Ø§Ù„ØªØ­Ù‚Ù‚');
        }
        
        const tokenData = await tokenResp.json();
        fpToken = tokenData.token;
        console.log('âœ… Token fetched securely from server');
        
      } catch (error) {
        console.error('âŒ Error fetching token:', error);
        animationPlayer.load('/img/notallowed.json');
        animationPlayer.play();
        statusIcon.src = '/img/payment-failure.svg';
        statusIcon.classList.add('show');
        status.textContent = `âŒ ${error.message}`;
        status.className = 'status err';
        return;
      }
      
      const referrerId = getReferrerIdFromUrl();
      
      // Ø¥Ù†Ø´Ø§Ø¡ fallback link
      let fallbackLink = 'https://t.me/TopGiveawaysBot';
      if(referrerId) {
        fallbackLink = `https://t.me/TopGiveawaysBot?start=ref_${referrerId}`;
        console.log('ğŸ“ Referrer found:', referrerId, 'Fallback link:', fallbackLink);
      }
      
      const payload = { 
        fingerprint: final, 
        meta:{ ua, rez, tz, lid, cfp, afp, ip: userIP }, 
        user_id: uid, 
        fp_token: fpToken,
        referrer_id: referrerId,
        fallback_link: fallbackLink
      };
      
      let success = false;
      
      // Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
      if(uid && fpToken){
        try {
          status.textContent='ğŸ“¡ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø²...';
          status.className='status pending';
          
          // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù€ URL Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ù€ API
          const apiUrl = `${API_CONFIG.getApiUrl()}/api/fingerprint`;
          console.log('ğŸ”— Sending request to:', apiUrl);
          console.log('ğŸ“¦ Payload (without sensitive data):', {
            user_id: uid,
            has_token: !!fpToken,
            fingerprint: final?.substring(0, 16) + '...'
          });
          
          const resp = await fetch(apiUrl, {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify(payload)
          });
          
          console.log('ğŸ“¨ Response status:', resp.status, resp.statusText);
          
          if(resp.ok){
            const result = await resp.json();
            if(result.ok){
              // Ù†Ø¬Ø­ Ø§Ù„ØªØ­Ù‚Ù‚ - Ø¹Ø±Ø¶ allowed animation
              animationPlayer.load('/img/allowed.json');
              animationPlayer.play();
              
              // Ø¹Ø±Ø¶ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
              statusIcon.src = '/img/payment-success.svg';
              statusIcon.classList.add('show');
              
              status.textContent='âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ Ø¨Ù†Ø¬Ø§Ø­!';
              status.className='status ok';
              success = true;
              
              // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†
              setTimeout(() => {
                if(window.Telegram?.WebApp) {
                  Telegram.WebApp.close();
                } else {
                  window.close();
                }
              }, 3000);
            } else {
              // ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ - Ø¹Ø±Ø¶ notallowed animation
              animationPlayer.load('/img/notallowed.json');
              animationPlayer.play();
              
              // Ø¹Ø±Ø¶ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ÙØ´Ù„
              statusIcon.src = '/img/payment-failure.svg';
              statusIcon.classList.add('show');
              
              const errorReason = result.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
              status.textContent=`âŒ ${errorReason}`;
              status.className='status err';
            }
          } else {
            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù… (403, 400, etc)
            console.error('âŒ Server error:', resp.status, resp.statusText);
            let errorMessage = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…';
            try {
              const errorData = await resp.json();
              console.error('ğŸ“‹ Error details:', errorData);
              errorMessage = errorData.error || errorData.message || errorMessage;
            } catch(e) {
              errorMessage = `Ø®Ø·Ø£ ${resp.status}: ${resp.statusText}`;
            }
            
            // Ø¹Ø±Ø¶ notallowed animation
            animationPlayer.load('/img/notallowed.json');
            animationPlayer.play();
            
            // Ø¹Ø±Ø¶ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ÙØ´Ù„
            statusIcon.src = '/img/payment-failure.svg';
            statusIcon.classList.add('show');
            
            if(resp.status === 403) {
              status.textContent='ğŸš« Ø¬Ù‡Ø§Ø² Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹ - Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„';
            } else {
              status.textContent=`âŒ ${errorMessage}`;
            }
            status.className='status err';
          }
        } catch(err){ 
          console.error('ğŸ’¥ Network/Fetch error:', err);
          console.error('Error details:', {
            name: err.name,
            message: err.message,
            stack: err.stack
          });
          
          // Ø¹Ø±Ø¶ notallowed animation
          animationPlayer.load('/img/notallowed.json');
          animationPlayer.play();
          
          // Ø¹Ø±Ø¶ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ÙØ´Ù„
          statusIcon.src = '/img/payment-failure.svg';
          statusIcon.classList.add('show');
          
          status.textContent='âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…';
          status.className='status err';
        }
      }
      
      if(!success && !uid){
        status.textContent='âš ï¸ Ø§ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ù…Ù† Ø²Ø± Ø¯Ø§Ø®Ù„ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…'; 
        status.className='status err';
        
        // Ø¹Ø±Ø¶ notallowed animation
        animationPlayer.load('/img/notallowed.json');
        animationPlayer.play();
        
        statusIcon.src = '/img/payment-failure.svg';
        statusIcon.classList.add('show');
      }
      
      return success;
    }
    
    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    await doSend();
  }

  try { 
    const fp = await import('https://openfpcdn.io/fingerprintjs/v3').then(x=>x.load()); 
    const result = await fp.get(); 
    console.log('FPJS ID:', result.visitorId);
  } catch(e) { 
    console.log('FPJS not available'); 
  }
  
  await build();
  
  if(window.Telegram && Telegram.WebApp){ 
    const theme = Telegram.WebApp.themeParams || {}; 
    const root=document.documentElement; 
    if(theme.bg_color) root.style.setProperty('--bg', theme.bg_color); 
    if(theme.secondary_bg_color) root.style.setProperty('--card', theme.secondary_bg_color); 
    if(theme.text_color) root.style.setProperty('--text', theme.text_color); 
  }
})();
</script>
</body>
</html>
